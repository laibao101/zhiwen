var all_user_img=[];$.ajax({type:"post",url:"show_all_user.php",async:!1,success:function(a){var b=$.parseJSON(a);$.extend(!0,all_user_img,b)}}),$(function(){function a(){$("#upload_img").on("click",function(){$(this).next().trigger("click")})}function b(){$.ajax({type:"post",url:"show_side_question.php",data:{user:$.cookie("user")},success:function(a){var b=$.parseJSON(a);$("#all_question").find(".badge").html(b.length),$("#side_member").html($.cookie("user"));var d=(c(),"");$(b).each(function(a){d+="<tr>								<td >"+(a+1)+"</td>								<td>"+$(this)[0].title.substring(0,11)+"...</td>							</tr>"}),$("#show_all_title").find("tbody").html(d)}})}function c(){function a(){$("#user_img").html('<span class="glyphicon glyphicon-user"></span>'+$.cookie("user")),$("#user_img").css("background-image","none"),$("#side_member").prev().html('<span class="glyphicon glyphicon-user"></span></a>')}if(all_user_img.length){for(var b=!1,c=0;c<all_user_img.length;c++)all_user_img[c].user==$.cookie("user")&&($("#user_img").html($.cookie("user")),$("#user_img").css("background-image","url(uploads/user/"+all_user_img[c].img+")"),$("#side_member").prev().html('<img src="uploads/user/'+all_user_img[c].img+'" style=""  class="img-responsive img-circle" alt="">'),b=!0);b||a()}else a()}$("#mobile_up_img").click(function(){$(".picture").trigger("click")}),$("#datetimepicker").datetimepicker({weekStart:0,todayHighlight:!0,show:!0,todayBtn:!0,autoclose:!0,showMeridian:!1,startView:2,language:"zh-CN",minView:2,keyboardNavigation:!0,format:"yyyy-mm-dd "}),$("#datetimepicker_side").datetimepicker({weekStart:0,todayHighlight:!0,show:!0,todayBtn:!0,autoclose:!0,showMeridian:!1,startView:2,language:"zh-CN",minView:2,keyboardNavigation:!0,format:"yyyy-mm-dd "});var d=new Date;d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();$(".choose .btn").click(function(){$(this).addClass("active").siblings().removeClass("active"),$(this).find("input").attr("checked","checked"),$(this).siblings().find("input").removeAttr("checked")}),$("#reg form").validate({submitHandler:function(a,b){function c(){$.ajax({type:"post",url:"add.php",data:d,success:function(){$("#loadding span").html("注册成功！").css("background-image","url(img/reg_succ.png)"),setTimeout(function(){$("#loadding").modal("hide"),$("#reg").addClass("modal").modal("hide"),setTimeout(function(){$("#loadding").html("正在提交").css("background-image","url(img/loading.gif)")},500)},800),$.cookie("user",$("#user").val()),$(".member").find("li:first a ").html('<span class="glyphicon glyphicon-user"></span>'+$.cookie("user")),$(".member").removeClass("hide"),$(".reg").addClass("hide"),$(a).resetForm(),$("#user_img").click(function(){$("#user-info .navbar-brand").trigger("click")})},beforeSend:function(){$("#loadding").modal("show"),$("#reg").removeClass("modal")}})}var d="";d=$("#reg form").serialize()+"&sex="+encodeURI($("#reg form .btn").find("input[checked=checked]").val())+"&birthday="+$("#datetimepicker").find("input").val(),$(a).ajaxSubmit({beforeSubmit:c})},showErrors:function(a,b){var c=this.numberOfInvalids();c>0?$("#reg").css("height",20*c+380):$("#reg").css("height",380),this.defaultShowErrors()},rules:{user:{minlength:6,required:!0,remote:{url:"is_user.php",type:"post"}},pass:{required:!0,minlength:6},email:{required:!0,email:!0},date:{date:!0}},messages:{user:{minlength:"请输入至少6位",required:"用户名不得为空",remote:"账号已经存在，请尝试其他账号"},pass:{minlength:"请输入至少6位",required:"密码不得为空"},email:{required:"邮箱不得为空"}},errorLabelContainer:"#reg_error",wrapper:"li"}),$("#side_reg form").validate({submitHandler:function(a,b){function c(){$.ajax({type:"post",url:"add.php",data:d,success:function(){$("#side_re").addClass("hide"),$("#user-info").removeClass("hide"),$("#loadding span").html("注册成功！").css("background-image","url(img/reg_succ.png)"),setTimeout(function(){$("#loadding").modal("hide"),setTimeout(function(){$("#loadding").html("正在提交").css("background-image","url(img/loading.gif)")},500)},800),$.cookie("user",$("#side_user").val()),$(".member").find("li:first a ").html('<span class="glyphicon glyphicon-user"></span> '+$.cookie("user")),$(".member").removeClass("hide"),$(".reg").addClass("hide"),$(a).resetForm(),$("#user_img").click(function(){$("#user-info .navbar-brand").trigger("click")})},beforeSend:function(){$("#loadding").modal("show")}})}var d="";d=$("#reg form").serialize()+"&sex="+encodeURI($("#reg form .btn").find("input[checked=checked]").val())+"&birthday="+$("#datetimepicker").find("input").val(),$(a).ajaxSubmit({beforeSubmit:c})},showErrors:function(a,b){var c=this.numberOfInvalids();c>0?$("#reg").css("height",20*c+380):$("#reg").css("height",380),this.defaultShowErrors()},rules:{user:{minlength:6,required:!0,remote:{url:"is_user.php",type:"post"}},pass:{required:!0,minlength:6},email:{required:!0,email:!0},date:{date:!0}},messages:{user:{minlength:"请输入至少6位",required:"用户名不得为空",remote:"账号已经存在，请尝试其他账号"},pass:{minlength:"请输入至少6位",required:"密码不得为空"},email:{required:"邮箱不得为空"}},errorLabelContainer:"#side_reg_error",wrapper:"li"}),$("form").resetForm(),$("#login form").validate({submitHandler:function(a){$(a).ajaxSubmit({type:"post",url:"login.php",beforeSubmit:function(){$("#loadding").modal("show"),$("#login").removeClass("modal")},success:function(){$("#user_img").click(function(){$("#user-info .navbar-brand").trigger("click")}),$("#loadding span").html("登录成功！").css("background-image","url(img/reg_succ.png)"),setTimeout(function(){$("#loadding").modal("hide"),$("#login").addClass("modal").modal("hide"),setTimeout(function(){$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},300)},700),$("input[name=expires]").is(":checked")?$.cookie("user",$("#login_user").val(),{expires:7}):$.cookie("user",$("#login_user").val()),c(),$(".member").removeClass("hide"),$(".reg").addClass("hide"),$(a).resetForm(),$("#user-info").removeClass("hide"),b(),$("#side_reg").addClass("hide")}})},errorLabelContainer:"#login_error",wrapper:"li",rules:{login_user:{required:!0,minlength:6},login_pass:{required:!0,minlength:6,remote:{url:"login.php",type:"post",data:{login_user:function(){return $("#login_user").val()}}}}},messages:{login_user:{required:"用户名不能为空",minlength:"用户名小于6位"},login_pass:{required:"密码不得为空",minlength:"密码不能少于6位",remote:"账号或者密码不正确"}}}),$(".exit").click(function(){$.cookie("user","",{expires:-1}),$(".member").find("li:first a ").html('<span class="glyphicon glyphicon-user"></span>注册知问'),$(".reg").removeClass("hide"),$(".member").addClass("hide"),$("#loadding").modal("show"),$("#loadding span").html("退出成功！").css("background-image","url(img/reg_succ.png)"),$("#user-info").addClass("hide"),setTimeout(function(){$("#loadding").modal("hide"),$("#side_reg").removeClass("hide"),setTimeout(function(){$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},300)},800)}),$(".picture").click(function(){$(this).next().trigger("click")}),$(".push").click(function(){if(""!=$("#question input[name=title]").val()){var a=new Date,b=a.getTime();if($("#file")[0].files[0]){var c=new FormData;c.append("file",$("#file")[0].files[0]),$.ajax({url:"post_content_img.php",type:"POST",cache:!1,data:c,processData:!1,contentType:!1,success:function(a){var c=$.parseJSON(a);$.ajax({type:"post",url:"add_content_img.php",data:{url:c.url,content_id:b},success:function(){console.log("图片保存成功")}})}})}var d="img/1.jpg";$.ajax({type:"post",url:"add_content.php",data:{user:$.cookie("user"),content:$("textarea[name=question]").val().replace(/\n/gi,""),title:$("#title").val(),content_id:b},beforeSend:function(){if($("#loadding").modal("show"),$("#question").removeClass("modal"),$(".push").addClass("disabled"),$("#file")[0].files[0]){var a=new FileReader;a.readAsDataURL($("#file")[0].files[0]),a.onload=function(a){var b=a.target.result;d=b}}},success:function(){$(".push").parents(".row").find("textarea[name=comment]").val(""),$(".badge").html(Number($(".badge").html())+1);var a="<tr><td>"+Number($(".badge").html())+"</td><td>"+$("#title").val().substring(0,11)+"...</td></tr>";$("#show_all_title").append(a),$.ajax({url:"show_content.php",type:"post",success:function(a){for(var b=$.parseJSON(a),c=0,e=0;e<b.length;e++)$("#title").val()==b[e].title&&(c=b[e].id);$("#loadding span").html("问题提交成功!").css("background-image","url(img/success.gif)");var f=new Date,g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDay()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds(),h="";h='<div class="media man"><div class="row media-body">						<p><span class="pub_user">'+$.cookie("user")+"</span><span>发表于</span><time>"+g+'</time></p>						<div class="media-left col-lg-3 col-md-3 col-xm-3">							<a href="javascript:;" class="thumbnail">								<img src="'+d+'" alt="" />							</a>						</div>						<div class=" col-lg-9 col-md-9 col-xm-9">							<h3 class="media-heading">'+$("#title").val()+"</h3>							<p>							"+$("textarea[name=question]").val()+'							</p>						</div>					</div>					<div class="row">						<ul class="nav navbar-nav ">							<li><a href="javascript:;" data-id="'+c+'">							<span class="glyphicon glyphicon-comment" ></span>							0条评论</a></li>							<li><a href="javascript:;" >							<span class="glyphicon glyphicon-send"></span>							分享</a></li>						</ul>			</div><div class="comment hide" ><textarea name="comment" rows="4" cols="" class="form-control"></textarea>									<div class="col-lg-offset-11 col-md-offset-11 col-xm-offset-10 col-xs-offset-10">									<button class="btn btn-default right  add_submit" data-id="'+c+'">提交</button>									</div></div></div><hr />				</div>',$("#content").prepend(h),setTimeout(function(){$("#loadding").modal("hide"),$("#question").addClass("modal").modal("hide"),$(".push").removeClass("disabled"),setTimeout(function(){$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},100),$("#question form").resetForm()},1200),$(".man .glyphicon-comment").parents("li").click(function(){var a=$(this).children("a"),b=$(this).parents(".media").find(".comment");b.hasClass("hide")?(a.css("background","#afd9ee"),b.removeClass("hide").css("display","none").slideDown("slow")):b.slideUp("fast",function(){b.addClass("hide"),a.css("background","white"),a.hover(function(){$(this).css("background","#eee")},function(){$(this).css("background","white")})})});var i=$(".man .glyphicon-comment").parents("li").children("a"),j=$(".man .glyphicon-comment").parents("li").parents(".media").find(".comment"),k=j.find(".add_submit");k.click(function(){$.cookie("user")?""!=j.find("textarea").val()?$.ajax({type:"post",url:"add_comment.php",data:{titleid:k.attr("data-id"),user:$.cookie("user"),comment:j.find("textarea").val()},beforeSend:function(){$("#loadding span").html("正在提交评论"),$("#loadding").modal("show")},success:function(){$("#loadding span").html("提交成功").css("background-image","url(img/reg_succ.png)"),setTimeout(function(){var a=$(".man .glyphicon-comment").parents("li").parents(".media").find(".comment");a.find("textarea").val(""),$("#loadding").modal("hide"),$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},500);var a=/[^0-9]+/g;i.html('<span class="glyphicon glyphicon-comment"></span> '+(Number(i.html().replace(a,""))+1)+"条评论");var b="",c=new Date,d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDay()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();b+='<div class="row">													<p><span class="pub_user">'+$.cookie("user")+"</span><span>发表于</span><time>"+d+'</time></p>												<div class="media-left col-lg-2 col-md-2 col-xm-3 col-xs-3">													<a href="javascript:;" class="thumbnail">													<img src="img/1.jpg" alt="" />													</a>													</div>													<div class=" col-lg-10 col-md-10 col-xm-9 col-xs-9">													<p>													'+j.find("textarea").val()+"												</p>												</div>												</div>",j.children().eq(0).hasClass(".row")?$(b).insertBefore(j.find(".row").eq(0)):$(b).insertBefore(j.find("textarea[name=comment]"))}}):alert("评论内容不能为空"):$("#login").modal("show")})}})}})}else alert("标题不能为空!")}),$(".question").click(function(){$.cookie("user")?($("#question").modal("show"),$("#question").removeClass("hide")):$("#login").modal("show")}),$("#side_exit_btn").click(function(){$("#login").modal("show")}),$("#side_exit").click(function(){$(".exit").trigger("click")}),$("#user-info .navbar-brand").click(function(){$("#upload_user_img").modal("show")}),a(),$("#upload_img").next().change(function(){var b=$(this)[0].files[0];$("#upload_img").prev().val($(this).val());var c=/^(image\/bmp|image\/gif|image\/jpeg|image\/png|image\/tiff)$/i;if(c.test(b.type)){var d,e=new FileReader;e.readAsDataURL(b),e.onload=function(c){d=c.target.result,$("#preview_user_img").attr("src",d),$("#preview_user_img").load(function(){var c=d;confirm("确定这张图片吗?")&&($("#upload_img").html("上传"),$("#upload_img").off("click").click(function(){var d=new FormData;d.append("file",b),"上传"==$("#upload_img").html()&&$.ajax({type:"post",url:"post_file.php",cache:!1,data:d,processData:!1,contentType:!1,beforeSend:function(){$("#upload_user_img").removeClass("modal"),$("#loadding").modal("show")},success:function(b){$("#user_img").css("background-image","url("+c+")"),$("#side_member").prev().html('<img src="'+c+'" style=""  class="img-responsive img-circle" alt="">'),$("#upload_user_img").addClass("modal").modal("hide"),$("#loadding span").html("头像上传成功").css("background-image","url(img/success.gif)"),setTimeout(function(){$("#loadding").modal("hide"),$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},800);var d=$.parseJSON(b),e=d.url.substring(d.url.indexOf("r/")+2);$.ajax({url:"add_user_img.php",type:"post",data:{url:e,user:$.cookie("user")},beforeSend:function(){},success:function(){a(),$("#upload_img").html("浏览")}})}})}))})}}else alert("不是图片文件，请重新选择")}),$.ajax({type:"post",url:"show_content.php",async:!1,success:function(a){var b=$.parseJSON(a),c="",d={};$.ajax({type:"post",url:"show_content_img.php",success:function(a){d=$.parseJSON(a);for(var e=0;e<d.length;e++)for(var f=0;f<b.length;f++)d[e].content_id==b[f].content_id&&(b[f].url=d[e].url);for(var e=0;e<b.length;e++)b[e].url||(b[e].url="img/1.jpg");$(b).each(function(){c+='<div class="media">							<div class="row">								<p><span class="pub_user">'+$(this)[0].user+"</span><span>发表于</span><time>"+$(this)[0].date+'</time></p>								<div class="media-left col-lg-3 col-md-3 col-xm-3">									<a href="javascript:;" class="thumbnail">										<img src="'+$(this)[0].url+'" alt="" />									</a>								</div>								<div class=" col-lg-9 col-md-9 col-xm-9">									<h3 class="media-heading">'+$(this)[0].title+"</h3>									<p>"+$(this)[0].content.substring(0,200)+'</p>								</div>							</div>							<div class="row">				<ul class="nav navbar-nav ">					<li><a href="javascript:;" class="comment_num" data-id='+$(this)[0].id+'>					<span class="glyphicon glyphicon-comment"></span>					'+$(this)[0].count+'条评论</a></li>				<li><a href="javascript:;">					<span class="glyphicon glyphicon-send"></span>					分享</a></li>				</ul>				</div><div class="comment hide" ></div></div><hr />					</div>'}),$("#content").append(c),$(".glyphicon-comment").parents("li").each(function(a,b){$(this).on("click","a",function(){var a=$(this),b=a.parents(".media").find(".comment");b.hasClass("hide")?(a.css("background","#afd9ee"),b.removeClass("hide").css("display","none").slideDown("slow"),$.ajax({type:"post",url:"show_comment.php",data:{titleid:a.attr("data-id")},success:function(c){function d(a){for(var b=0;b<a.length;b++)for(var c=0;c<all_user_img.length;c++)a[b].user==all_user_img[c].user&&(a[b].url=all_user_img[c].img);for(var b=0;b<a.length;b++)a[b].url||(a[b].url="1.jpg")}var e=$.parseJSON(c),f="";b.html("");var g=0;0!=e.length&&(d(e),g=Number(e[0].count),$(e).each(function(a,b){f+='<div class="row">												<p><span class="pub_user">'+$(this)[0].user+"</span><span>发表于</span><time>"+$(this)[0].date+'</time></p>											<div class="media-left col-lg-2 col-md-2 col-xm-3 col-xs-3">												<a href="javascript:;" class="thumbnail">												<img src="uploads/user/'+$(this)[0].url+'" alt="" />												</a>												</div>												<div class=" col-lg-10 col-md-10 col-xm-9 col-xs-9">												<p>												'+$(this)[0].comment+"											</p>											</div>											</div>"}));var h=2;g>=h&&(f+='<button class="btn btn-default btn-block load" data-id="'+a.attr("data-id")+'">加载更多评论</button>'),f+='<textarea name="comment" rows="4" cols="" class="form-control"></textarea>										<div class="col-lg-offset-11 col-md-offset-11 col-xm-offset-10 col-xs-offset-10">										<button class="btn btn-default right  add_submit" data-id="'+a.attr("data-id")+'">提交</button>										</div>',b.append(f);var i=b.find(".load");i&&$(".load").click(function(){g>=h&&(i.html("<span ><img src='img/more_load.gif'/></span>"),$.ajax({type:"post",url:"show_comment.php",data:{titleid:a.attr("data-id"),page:h++},success:function(a){var b=$.parseJSON(a),c="";d(b),console.log(b),$(b).each(function(){c+='<div class="row">															<p><span class="pub_user">'+$(this)[0].user+"</span><span>发表于</span><time>"+$(this)[0].date+'</time></p>														<div class="media-left col-lg-2 col-md-2 col-xm-3 col-xs-3">															<a href="javascript:;" class="thumbnail">															<img src="uploads/user/'+$(this)[0].url+'" alt="" />															</a>															</div>															<div class=" col-lg-10 col-md-10 col-xm-9 col-xs-9">															<p>															'+$(this)[0].comment+"														</p>														</div>														</div>"}),$(c).insertBefore(i),i.html("加载更多评论"),h>g&&i.remove()}}))});var j=b.find(".add_submit");j.click(function(){$.cookie("user")?""!=b.find("textarea").val()?$.ajax({type:"post",url:"add_comment.php",data:{titleid:j.attr("data-id"),user:$.cookie("user"),comment:b.find("textarea").val()},beforeSend:function(){$("#loadding span").html("正在提交评论"),$("#loadding").modal("show")},success:function(){console.log(all_user_img);for(var c="",d=0;d<all_user_img.length;d++)all_user_img[d].user==$.cookie("user")&&(c=all_user_img[d].img);""==c&&(c="1.jpg");var e="",f=new Date,g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDay()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();e='<div class="row">																	<p><span class="pub_user">'+$.cookie("user")+"</span><span>发表于</span><time>"+g+'</time></p>																<div class="media-left col-lg-2 col-md-2 col-xm-3 col-xs-3">																	<a href="javascript:;" class="thumbnail">																	<img src="uploads/user/'+c+'" alt="" />																	</a>																		</div>																		<div class=" col-lg-10 col-md-10 col-xm-9 col-xs-9">																		<p>																		'+b.find("textarea").val()+"																	</p>																	</div>																	</div>",b.children().eq(0).hasClass("row")?$(e).insertBefore(b.find(".row").eq(0)):$(e).insertBefore(b.find("textarea[name=comment]")),$("#loadding span").html("提交成功").css("background-image","url(img/reg_succ.png)"),setTimeout(function(){var a=$(".glyphicon-comment").parents("li").parents(".media").find(".comment");a.find("textarea").val(""),$("#loadding").modal("hide"),$("#loadding span").html("正在提交").css("background-image","url(img/loading.gif)")},500);var h=/[^0-9]+/g;a.html('<span class="glyphicon glyphicon-comment"></span> '+(Number(a.html().replace(h,""))+1)+"条评论")}}):alert("评论内容不能为空"):$("#login").modal("show")})},beforeSend:function(){var a="";a='<div class="row load_con" >									<span class="loadding">正在加载评论</span>									</div>',b.append(a)}})):b.slideUp("fast",function(){b.addClass("hide"),a.css("background","white"),a.hover(function(){$(this).css("background","#eee")},function(){$(this).css("background","white")})})})})}})}}),$.cookie("user")&&($(".member").find("li:first a ").html($.cookie("user")),$(".member").removeClass("hide"),$(".reg").addClass("hide"),$("#side_reg").addClass("hide"),c(),$("#user-info").removeClass("hide"),b(),$("#user_img").click(function(){$("#user-info .navbar-brand").trigger("click")}))}),$(window).load(function(){setTimeout(function(){$("#footer").css({position:"static"})},1e3)});